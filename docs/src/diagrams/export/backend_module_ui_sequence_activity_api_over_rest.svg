<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1487px" preserveAspectRatio="none" style="width:2076px;height:1487px;" version="1.1" viewBox="0 0 2076 1487" width="2076px" zoomAndPan="magnify"><defs><filter height="300%" id="fjonwlix7huzz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#fjonwlix7huzz)" height="1473.7188" style="stroke: #000000; stroke-width: 1.0;" width="2057.5" x="8" y="3"/><path d="M191,4 L191,12.2969 L181,22.2969 L8,22.2969 " fill="none" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="11" y="16.9951">Activity API over REST</text><rect fill="#FFFFFF" filter="url(#fjonwlix7huzz)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="230" x="987.5" y="495.4141"/><rect fill="#FFFFFF" filter="url(#fjonwlix7huzz)" height="147.0625" style="stroke: #000000; stroke-width: 2.0;" width="798" x="987.5" y="1054.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="64" x2="64" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="328" x2="328" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="588" x2="588" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1054.5" x2="1054.5" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1225.5" x2="1225.5" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1443.5" x2="1443.5" y1="80.8906" y2="1422.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1752" x2="1752" y1="80.8906" y2="1422.125"/><rect fill="#90EE90" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="98" x="13" y="29.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="47.5" y="49.292">CLI :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="20" y="65.5889">RestClientUI</text><rect fill="#90EE90" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="98" x="13" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="47.5" y="1441.1201">CLI :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="20" y="1457.417">RestClientUI</text><rect fill="#ADD8E6" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="264" y="29.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="271" y="49.292">REST backend :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="284" y="65.5889">FlaskWorker</text><rect fill="#ADD8E6" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="124" x="264" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="110" x="271" y="1441.1201">REST backend :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="284" y="1457.417">FlaskWorker</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="531" y="45.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="538" y="65.5889">ActivityWorker</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="531" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="538" y="1441.1201">ActivityWorker</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="111" x="997.5" y="45.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="97" x="1004.5" y="65.5889">ActivityService</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="111" x="997.5" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="97" x="1004.5" y="1441.1201">ActivityService</text><rect fill="#ADD8E6" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1130.5" y="29.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="1204" y="49.292">ODA :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1137.5" y="65.5889">Observation Data Archive</text><rect fill="#ADD8E6" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="1130.5" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="1204" y="1441.1201">ODA :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="173" x="1137.5" y="1457.417">Observation Data Archive</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="220" x="1331.5" y="29.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="1399" y="49.292">SESWorker :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="206" x="1338.5" y="65.5889">ScriptExecutionServiceWorker</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="220" x="1331.5" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="1399" y="1441.1201">SESWorker :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="206" x="1338.5" y="1457.417">ScriptExecutionServiceWorker</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="1665" y="29.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="1678" y="49.292">Script Execution API :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="1672" y="65.5889">ScriptExecutionService</text><rect fill="#FEFECE" filter="url(#fjonwlix7huzz)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="1665" y="1421.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="1678" y="1441.1201">Script Execution API :</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="1672" y="1457.417">ScriptExecutionService</text><polygon fill="#A80036" points="316,143.2891,326,147.2891,316,151.2891,320,147.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64" x2="322" y1="147.2891" y2="147.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="71" y="142.2231">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="84" y="142.2231">HTTP POST to /api/v1/activities</text><path d="M333,95.8906 L333,180.8906 L632,180.8906 L632,105.8906 L622,95.8906 L333,95.8906 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M622,95.8906 L622,105.8906 L632,105.8906 L622,95.8906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="339" y="112.9575">The User executes an OET CLI command at</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="339" y="128.0903">the terminal. The OET CLI uses HTTP POST</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="339" y="143.2231">to send a JSON object encapsulating the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="339" y="158.356">request (activity name, scheduling block ID,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="339" y="173.4888">etc.) to the REST backend.</text><polygon fill="#A80036" points="576,242.9531,586,246.9531,576,250.9531,580,246.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="328" x2="582" y1="246.9531" y2="246.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="335" y="241.8872">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="348" y="241.8872">send message request.activity.run</text><path d="M593,195.5547 L593,280.5547 L938,280.5547 L938,205.5547 L928,195.5547 L593,195.5547 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M928,195.5547 L928,205.5547 L938,205.5547 L928,195.5547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="599" y="212.6216">FlaskWorker</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="691" y="212.6216">creates a</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="755" y="212.6216">ActivityCommand</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="599" y="227.7544">encapsulating the request details and announces</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="599" y="242.8872">the event on the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="146" x="709" y="242.8872">Run Activity requested</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="859" y="242.8872">request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="599" y="258.02">topic. It will then wait for a response on the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="48" x="875" y="258.02">Activity</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="48" x="599" y="273.1528">running</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="651" y="273.1528">response topic.</text><polygon fill="#A80036" points="1043,350.1836,1053,354.1836,1043,358.1836,1047,354.1836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="1049" y1="354.1836" y2="354.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="349.1177">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="388" x="608" y="349.1177">prepare_run_activity(cmd: ActivityCommand, request_id: int)</text><path d="M1060,295.2188 L1060,395.2188 L1399,395.2188 L1399,305.2188 L1389,295.2188 L1060,295.2188 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1389,295.2188 L1389,305.2188 L1399,305.2188 L1389,295.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1066" y="312.2856">Pass the request_id to ActivityService where it</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1066" y="327.4185">keeps a record of request IDs mapped to activity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="1066" y="342.5513">IDs. This is so that the service can use the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1066" y="357.6841">request ID in messages sent to the procedure</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="1066" y="372.8169">domain and any events published from procedure</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="1066" y="387.9497">domain are linked to the correct activity.</text><polygon fill="#A80036" points="1214,434.7148,1224,438.7148,1214,442.7148,1218,438.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1220" y1="438.7148" y2="438.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1062" y="433.6489">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1075" y="433.6489">oda.sbds.get(sbd_id)</text><path d="M1231,410.0156 L1231,450.0156 L1585,450.0156 L1585,420.0156 L1575,410.0156 L1231,410.0156 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1575,410.0156 L1575,420.0156 L1585,420.0156 L1575,410.0156 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="1237" y="427.0825">Retrieve the Scheduling Block Definition from ODA.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="1237" y="442.2153">The ODA client will return a SBDefinition PDM object.</text><polygon fill="#A80036" points="1066,476.4141,1056,480.4141,1066,484.4141,1062,480.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1060" x2="1225" y1="480.4141" y2="480.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1072" y="475.3481">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1085" y="475.3481">pdm.SBDefinition</text><path d="M987.5,495.4141 L1057.5,495.4141 L1057.5,502.4141 L1047.5,512.4141 L987.5,512.4141 L987.5,495.4141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="230" x="987.5" y="495.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="1002.5" y="508.481">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1072.5" y="507.6245">[script_args provided]</text><path d="M1222.5,500.4141 L1222.5,555.4141 L1613.5,555.4141 L1613.5,510.4141 L1603.5,500.4141 L1222.5,500.4141 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1603.5,500.4141 L1603.5,510.4141 L1613.5,510.4141 L1603.5,500.4141 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="1228.5" y="517.481">If user has provided additional arguments for the script,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1228.5" y="532.6138">the retrieved SB is updated to include any additional</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="1228.5" y="547.7466">arguments and overwrite any existing keyword arguments</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1097" y1="533.6797" y2="533.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1097" x2="1097" y1="533.6797" y2="546.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1056" x2="1097" y1="546.6797" y2="546.6797"/><polygon fill="#A80036" points="1066,542.6797,1056,546.6797,1066,550.6797,1062,546.6797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1062" y="528.6138">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="1075" y="528.6138">update SB args</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1097" y1="604.0117" y2="604.0117"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1097" x2="1097" y1="604.0117" y2="617.0117"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1056" x2="1097" y1="617.0117" y2="617.0117"/><polygon fill="#A80036" points="1066,613.0117,1056,617.0117,1066,621.0117,1062,617.0117" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1062" y="598.9458">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1075" y="598.9458">write SB to file</text><path d="M1178,566.6797 L1178,636.6797 L1573,636.6797 L1573,576.6797 L1563,566.6797 L1178,566.6797 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1563,566.6797 L1563,576.6797 L1573,576.6797 L1563,566.6797 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1184" y="583.7466">ActivityService will write SB JSON to file with a unique</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1184" y="598.8794">name consisting of SB ID, SB version and timestamp. SBs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="1184" y="614.0122">are stored in folder /tmp/sbs/ and path to the SB is passed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="1184" y="629.145">as an argument in the PrepareProcessCommand</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1097" y1="680.9766" y2="680.9766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1097" x2="1097" y1="680.9766" y2="693.9766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1056" x2="1097" y1="693.9766" y2="693.9766"/><polygon fill="#A80036" points="1066,689.9766,1056,693.9766,1066,697.9766,1062,693.9766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1062" y="675.9106">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1075" y="675.9106">add SB path to kwargs</text><path d="M1231,651.2109 L1231,706.2109 L1586,706.2109 L1586,661.2109 L1576,651.2109 L1231,651.2109 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1576,651.2109 L1576,661.2109 L1586,661.2109 L1576,651.2109 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1237" y="668.2778">The SB JSON filepath string is appended to the list of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="1237" y="683.4106">script keyword arguments for</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="32" x="1427" y="683.4106">main</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="1463" y="683.4106">function under</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1237" y="698.5435">the key</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="48" x="1288" y="698.5435">sb_json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1336" y="698.5435">.</text><polygon fill="#A80036" points="1431.5,768.0078,1441.5,772.0078,1431.5,776.0078,1435.5,772.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1437.5" y1="772.0078" y2="772.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1062" y="766.9419">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="1075" y="766.9419">message request.procedure.prepare</text><path d="M1448,720.6094 L1448,805.6094 L1835,805.6094 L1835,730.6094 L1825,720.6094 L1448,720.6094 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1825,720.6094 L1825,730.6094 L1835,730.6094 L1825,720.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="1454" y="737.6763">ActivityService creates a PrepareProcessCommand and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="1454" y="752.8091">announces it on the Create Procedure topic. It then</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="1454" y="767.9419">waits for the response topic Procedure Created and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="1454" y="783.0747">creates an ActivitySummary based on  the response that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="1454" y="798.2075">is passed on to the REST backend and client.</text><polygon fill="#A80036" points="1740.5,832.4063,1750.5,836.4063,1740.5,840.4063,1744.5,836.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1443.5" x2="1746.5" y1="836.4063" y2="836.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1450.5" y="831.3403">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1472.5" y="831.3403">prepare(cmd: PrepareProcessCommand)</text><polygon fill="#A80036" points="1454.5,861.5391,1444.5,865.5391,1454.5,869.5391,1450.5,865.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1448.5" x2="1751.5" y1="865.5391" y2="865.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1460.5" y="860.4731">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1482.5" y="860.4731">ProcedureSummary</text><polygon fill="#A80036" points="599,890.6719,589,894.6719,599,898.6719,595,894.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="593" x2="1442.5" y1="894.6719" y2="894.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="605" y="889.606">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="627" y="889.606">message procedure.lifecycle.created</text><polygon fill="#A80036" points="1043,977.7695,1053,981.7695,1043,985.7695,1047,981.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="1049" y1="981.7695" y2="981.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="595" y="976.7036">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="617" y="976.7036">complete_run_activity(result: ProcedureSummary, request_id: int)</text><path d="M1060,907.6719 L1060,1038.6719 L1495,1038.6719 L1495,917.6719 L1485,907.6719 L1060,907.6719 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1485,907.6719 L1485,917.6719 L1495,917.6719 L1485,907.6719 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="1066" y="924.7388">ActivityService inspects each procedure.lifecycle.created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="1066" y="939.8716">message and checks if the request ID maps to any activity.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1066" y="955.0044">This check is done to make sure that the message has</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="1066" y="970.1372">originated from a procedure created by the activity domain</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="1066" y="985.27">rather than independently by the procedure domain.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="1066" y="1000.4028">If the request ID does not map to an activity, ActivityService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="1066" y="1015.5356">will return a null response to ActivityWorker which will know</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="1066" y="1030.6685">to keep waiting for another procedure.lifecycle.created message.</text><path d="M987.5,1054.7344 L1057.5,1054.7344 L1057.5,1061.7344 L1047.5,1071.7344 L987.5,1071.7344 L987.5,1054.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="147.0625" style="stroke: #000000; stroke-width: 2.0;" width="798" x="987.5" y="1054.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="1002.5" y="1067.8013">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="142" x="1072.5" y="1066.9448">[prepare_only not set]</text><path d="M1790.5,1059.7344 L1790.5,1174.7344 L2058.5,1174.7344 L2058.5,1069.7344 L2048.5,1059.7344 L1790.5,1059.7344 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2048.5,1059.7344 L2048.5,1069.7344 L2058.5,1069.7344 L2048.5,1059.7344 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="35" x="1796.5" y="1076.8013">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1796.5" y="1091.9341">If</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="1807.5" y="1091.9341">prepare_only</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="1907.5" y="1091.9341">flag is not set, the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="1796.5" y="1107.0669">ActivityService creates and announces</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="1796.5" y="1122.1997">a StartProcessCommand but currently</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1796.5" y="1137.3325">does not wait for response to further</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="1796.5" y="1152.4653">follow the lifecycle of the created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="1796.5" y="1167.5981">procedure</text><polygon fill="#A80036" points="1431.5,1139.3984,1441.5,1143.3984,1431.5,1147.3984,1435.5,1143.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1055" x2="1437.5" y1="1143.3984" y2="1143.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1062" y="1138.3325">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="1084" y="1138.3325">message request.procedure.start (force=true)</text><path d="M1448,1076.8672 L1448,1191.8672 L1766,1191.8672 L1766,1086.8672 L1756,1076.8672 L1448,1076.8672 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1756,1076.8672 L1756,1086.8672 L1766,1086.8672 L1756,1076.8672 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1454" y="1093.9341">By default the ScriptExecutionServiceWorker</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="1454" y="1109.0669">does not allow a StartProcessCommand to be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="1454" y="1124.1997">queued if the process is not yet ready to start.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="1454" y="1139.3325">Instead of the ActivityService waiting for the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1454" y="1154.4653">process to be ready, set a flag to tell the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="1454" y="1169.5981">SESWorker to ignore the current process state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1454" y="1184.731">and queue the start command anyway.</text><polygon fill="#A80036" points="599,1225.9297,589,1229.9297,599,1233.9297,595,1229.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="593" x2="1054" y1="1229.9297" y2="1229.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="605" y="1224.8638">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="627" y="1224.8638">ActivitySummary</text><polygon fill="#A80036" points="339,1255.0625,329,1259.0625,339,1263.0625,335,1259.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="333" x2="587" y1="1259.0625" y2="1259.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="345" y="1253.9966">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="367" y="1253.9966">message activity.lifecycle.running</text><polygon fill="#A80036" points="75,1342.1602,65,1346.1602,75,1350.1602,71,1346.1602" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="69" x2="327" y1="1346.1602" y2="1346.1602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="81" y="1341.0942">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="103" y="1341.0942">HTTP OK + ActivitySummary JSON</text><path d="M333,1272.0625 L333,1403.0625 L688,1403.0625 L688,1282.0625 L678,1272.0625 L333,1272.0625 " fill="#FBFB77" filter="url(#fjonwlix7huzz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M678,1272.0625 L678,1282.0625 L688,1282.0625 L678,1272.0625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="339" y="1289.1294">The FlaskWorker will block the client side until it</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="339" y="1304.2622">receives a message on activity.lifecycle.running</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="339" y="1319.395">topic from the ActivityWorker indicating that the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="339" y="1334.5278">preparation on the activity has been started.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="339" y="1349.6606">Afterwards the user can stay updated on the activity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="339" y="1364.7935">status by querying the procedure CLI with the script</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="339" y="1379.9263">ID given by the ActivitySummary or by listening to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="339" y="1395.0591">the lifecycle events.</text><!--MD5=[7a1fbfd6a9f1e7c0395755cfb3ebb613]
@startuml


mainframe **Activity API over REST**

autonumber

participant cli as "CLI :\nRestClientUI" #lightgreen
participant FlaskWorker as "REST backend :\nFlaskWorker" #lightblue
participant ActivityWorker
participant ActivityService
participant ODA as "ODA :\nObservation Data Archive" #lightblue
participant ScriptExecutionServiceWorker as "SESWorker :\nScriptExecutionServiceWorker"
participant ScriptExecutionService as "Script Execution API :\nScriptExecutionService"

cli -> FlaskWorker: HTTP POST to /api/v1/activities
note right
The User executes an OET CLI command at
the terminal. The OET CLI uses HTTP POST
to send a JSON object encapsulating the
request (activity name, scheduling block ID,
etc.) to the REST backend.
end note

FlaskWorker -> ActivityWorker: send message request.activity.run
note right
""FlaskWorker"" creates a ""ActivityCommand""
encapsulating the request details and announces
the event on the //Run Activity requested// request
topic. It will then wait for a response on the //Activity//
//running// response topic.
end note

ActivityWorker -> ActivityService: prepare_run_activity(cmd: ActivityCommand, request_id: int)
note right
Pass the request_id to ActivityService where it
keeps a record of request IDs mapped to activity
IDs. This is so that the service can use the
request ID in messages sent to the procedure
domain and any events published from procedure
domain are linked to the correct activity.
end note

ActivityService -> ODA: oda.sbds.get(sbd_id)
note right
Retrieve the Scheduling Block Definition from ODA.
The ODA client will return a SBDefinition PDM object.
end note
ODA -> ActivityService: pdm.SBDefinition

opt script_args provided
ActivityService -> ActivityService: update SB args
end
note right
If user has provided additional arguments for the script,
the retrieved SB is updated to include any additional
arguments and overwrite any existing keyword arguments
end note

ActivityService -> ActivityService: write SB to file
note right
ActivityService will write SB JSON to file with a unique
name consisting of SB ID, SB version and timestamp. SBs
are stored in folder /tmp/sbs/ and path to the SB is passed
as an argument in the PrepareProcessCommand
end note

ActivityService -> ActivityService: add SB path to kwargs
note right
The SB JSON filepath string is appended to the list of
script keyword arguments for //main// function under 
the key //sb_json//.
end note


ActivityService -> ScriptExecutionServiceWorker: message request.procedure.prepare

note right
ActivityService creates a PrepareProcessCommand and
announces it on the Create Procedure topic. It then
waits for the response topic Procedure Created and
creates an ActivitySummary based on  the response that
is passed on to the REST backend and client.
end note

ScriptExecutionServiceWorker -> ScriptExecutionService: prepare(cmd: PrepareProcessCommand)

ScriptExecutionService -> ScriptExecutionServiceWorker: ProcedureSummary

ScriptExecutionServiceWorker -> ActivityWorker: message procedure.lifecycle.created

ActivityWorker -> ActivityService: complete_run_activity(result: ProcedureSummary, request_id: int)

note right
ActivityService inspects each procedure.lifecycle.created
message and checks if the request ID maps to any activity.
This check is done to make sure that the message has
originated from a procedure created by the activity domain
rather than independently by the procedure domain.
If the request ID does not map to an activity, ActivityService
will return a null response to ActivityWorker which will know
to keep waiting for another procedure.lifecycle.created message.
end note

opt prepare_only not set
ActivityService -> ScriptExecutionServiceWorker: message request.procedure.start (force=true)
note right
By default the ScriptExecutionServiceWorker
does not allow a StartProcessCommand to be
queued if the process is not yet ready to start.
Instead of the ActivityService waiting for the
process to be ready, set a flag to tell the
SESWorker to ignore the current process state
and queue the start command anyway.
end note


end
note right
**Note**
If **prepare_only** flag is not set, the
ActivityService creates and announces
a StartProcessCommand but currently
does not wait for response to further
follow the lifecycle of the created
procedure
end note

ActivityService -> ActivityWorker: ActivitySummary

ActivityWorker -> FlaskWorker: message activity.lifecycle.running

cli <- FlaskWorker: HTTP OK + ActivitySummary JSON
note right
The FlaskWorker will block the client side until it
receives a message on activity.lifecycle.running
topic from the ActivityWorker indicating that the
preparation on the activity has been started.
Afterwards the user can stay updated on the activity
status by querying the procedure CLI with the script
ID given by the ActivitySummary or by listening to
the lifecycle events.
end note

@enduml

PlantUML version 1.2020.06(Sun Apr 05 12:38:32 GMT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 14-ea+33
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>