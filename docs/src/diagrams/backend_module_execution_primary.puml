@startuml
'https://plantuml.com/class-diagram

package ska_oso_oet.procedure {

package application as application_pkg {

    package restclient <<Rectangle>> {
        class RestClientUI {
            create(...)
            start(...)
            stop(...)
            list(...)
            describe(...)
            listen(...)
        }
    }

    package main <<Rectangle>> {
        class ScriptExecutionServiceWorker {
            prepare(...)
            start(...)
            stop(...)
            list(...)
            on_load(evt: EventMessage)
            on_run(evt: EventMessage)
            on_env(evt: EventMessage)
            on_pubsub(evt: EventMessage)
        }

        class FlaskWorker {
        }

        class EventBusWorker {
            main_loop(...)
            main_func(...)
            republish(...)
        }

        ScriptExecutionServiceWorker --> EventBusWorker
        FlaskWorker --> EventBusWorker
    }

    package restserver <<Rectangle>> {
        class app <<function return value>> {
        }

        class ProcedureAPI

        app o-- ProcedureAPI
    }

    package application <<Rectangle>> {
        class ScriptExecutionService {
            prepare(cmd: PrepareProcessCommand) -> ProcedureSummary
            start(cmd: StartProcessCommand) -> ProcedureSummary
            stop(cmd: StopProcessCommand) -> List[ProcedureSummary]
            summarise(pids: List[int]) -> List[[ProcedureSummary]
        }

        class ProcedureSummary {
            id: int
            script: domain.ExecutableScript
            script_args: List[ArgCapture]
            state: domain.ProcedureState
        }

        class ArgCapture {
            fn: str
            fn_args: domain.ProcedureInput
            time: float
        }
        ProcedureSummary -right-|> ArgCapture

        class ProcedureHistory {
            {field} process_states: List[(ProcedureState, time)]
            stacktrace: Optional[str]
        }
        ProcedureSummary --> ProcedureHistory

        class PrepareProcessCommand {
            script: domain.ExecutableScript
            init_args: domain.ProcedureInput
        }

        class StartProcessCommand {
            process_uid: int
            fn_name: str
            run_args: domain.ProcedureInput
        }

        class StopProcessCommand {
            process_uid: int
            run_abort: bool
        }
        PrepareProcessCommand -up[hidden]- StartProcessCommand
        StartProcessCommand -up[hidden]- StopProcessCommand
    }
    FlaskWorker *-- app
    ScriptExecutionServiceWorker *-- ScriptExecutionService

}

    package domain <<Rectangle>> {
        abstract class ExecutableScript
        class GitScript
        class FilesystemScript
        class EmbeddedStringScript
        GitScript --> ExecutableScript
        FilesystemScript --> ExecutableScript
        EmbeddedStringScript --> ExecutableScript

        enum ProcedureState {
            UNKNOWN
            CREATING
            IDLE
            LOADING
            READY
            RUNNING
            COMPLETE
            STOPPED
            FAILED
        }

        class ProcedureInput {
            args: List
            kwargs: Dict[str, Any]
        }
    }

    ProcedureHistory ---> ProcedureState
    ProcedureSummary ---> ProcedureInput
}

package flask {
    class Flask
    class Blueprint
}

app -|> Flask
ProcedureAPI -|> Blueprint

main -down[hidden]--> application
restserver -left[hidden]--> application
restserver -right[hidden]--> flask
FlaskWorker -down[hidden]--> restserver
ScriptExecutionService -down[hidden]- ProcedureSummary

@enduml
